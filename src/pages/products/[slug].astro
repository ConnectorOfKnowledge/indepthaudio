---
/**
 * /products/[slug] – Individual product detail page.
 * Generates one page per product at build time.
 */
import Layout from "../../layouts/Layout.astro";
import {
  products,
  getProductBySlug,
  formatPrice,
  formatPriceRange,
  finishSlug,
  swatchPath,
  FINISH_PHOTO_MAP,
  SHIPPING_NOTE,
  CUSTOM_ORDER_LEAD,
  PHONE_NUMBER,
  PHONE_HREF,
} from "../../data/products";
import type { Product, FinishOption } from "../../data/products";

export function getStaticPaths() {
  return products.map((p) => ({
    params: { slug: p.slug },
    props: { product: p },
  }));
}

interface Props {
  product: Product;
}

const { product } = Astro.props;

const heroSrc = `/images/products/${product.slug}/${product.heroImage}`;

function finishesByTier(tier: FinishOption["tier"]) {
  return product.finishes.filter((f) => f.tier === tier);
}

// Finish photo map for this specific speaker
const speakerFinishMap = FINISH_PHOTO_MAP[product.slug] || {};

// Build "related" products (everything except current)
const related = products.filter((p) => p.slug !== product.slug).sort((a, b) => a.order - b.order).slice(0, 3);
---

<Layout
  title={`${product.name} | In Depth Audio`}
  description={product.cardDescription}
>

  <!-- ─── NAV ───────────────────────────────────────────────────── -->
  <nav id="nav" class="fixed top-0 w-full z-50 transition-all duration-500 bg-transparent border-b border-transparent">
    <div class="max-w-7xl mx-auto px-6 lg:px-12 flex items-center justify-between h-20">
      <a href="/" class="font-display text-xl text-ink-100 tracking-wide hover:text-gold-400 transition-colors">
        In Depth Audio
      </a>
      <div class="hidden md:flex items-center gap-10">
        <a href="/#services" class="nav-link">Services</a>
        <a href="/products" class="nav-link">Speakers</a>
        <a href="/#about" class="nav-link">About</a>
        <a href="/#contact" class="nav-link">Book Consultation</a>
      </div>
      <button id="mobile-menu-btn" class="md:hidden text-ink-300 hover:text-gold-400 transition-colors" aria-label="Menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
    <div id="mobile-drawer" class="md:hidden hidden bg-[#080808ee] backdrop-blur-xl border-t border-[#2a2520]">
      <div class="px-6 py-8 flex flex-col gap-6">
        <a href="/#services" class="nav-link text-base">Services</a>
        <a href="/products" class="nav-link text-base">Speakers</a>
        <a href="/#about" class="nav-link text-base">About</a>
        <a href="/#contact" class="nav-link text-base">Book Consultation</a>
        <div class="gold-rule mt-2"></div>
        <a href={PHONE_HREF} class="text-ink-300 text-sm font-label tracking-wider">{PHONE_NUMBER}</a>
      </div>
    </div>
  </nav>

  <!-- ─── BREADCRUMB ────────────────────────────────────────────── -->
  <div class="pt-24 pb-4">
    <div class="max-w-7xl mx-auto px-6 lg:px-12">
      <nav class="flex items-center gap-2 text-[0.65rem] font-label tracking-[0.15em] uppercase">
        <a href="/" class="text-ink-400 hover:text-gold-400 transition-colors">Home</a>
        <span class="text-ink-500">/</span>
        <a href="/products" class="text-ink-400 hover:text-gold-400 transition-colors">Speakers</a>
        <span class="text-ink-500">/</span>
        <span class="text-ink-300">{product.name}</span>
      </nav>
    </div>
  </div>

  <!-- ─── PRODUCT HERO ──────────────────────────────────────────── -->
  <section class="pb-16 lg:pb-24">
    <div class="max-w-7xl mx-auto px-6 lg:px-12">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 items-start">

        <!-- LEFT: Image column -->
        <div class="fade-up">
          <div class="relative overflow-hidden bg-[#111111]">
            <img
              id="main-image"
              src={heroSrc}
              alt={product.name}
              class="w-full aspect-[3/4] object-cover object-center block transition-opacity duration-200"
            />
            <!-- Badges -->
            <div class="absolute top-4 left-4 flex flex-col gap-2">
              {product.instantShip && (
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 text-[0.6rem] font-semibold tracking-[0.2em] uppercase font-label bg-[rgba(201,166,74,0.15)] text-gold-400 border border-gold-500/30 backdrop-blur-sm">
                  <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                  Instant Ship
                </span>
              )}
              {product.discontinued && product.badge && (
                <span class="inline-flex items-center px-3 py-1.5 text-[0.6rem] font-semibold tracking-[0.2em] uppercase font-label bg-[rgba(220,38,38,0.12)] text-red-400 border border-red-500/25 backdrop-blur-sm">
                  {product.badge}
                </span>
              )}
            </div>
          </div>

          <!-- Thumbnail gallery -->
          {product.gallery.length > 0 && (
            <div class="grid grid-cols-5 sm:grid-cols-6 gap-2 mt-3">
              <button
                class="gallery-thumb active-thumb relative overflow-hidden aspect-square border border-gold-500/40"
                data-src={heroSrc}
              >
                <img src={heroSrc} alt="Hero" class="w-full h-full object-cover" loading="lazy" />
              </button>
              {product.gallery.slice(0, 11).map((img) => (
                <button
                  class="gallery-thumb relative overflow-hidden aspect-square border border-[#2a2520] hover:border-gold-500/40 transition-colors"
                  data-src={`/images/products/${product.slug}/${img}`}
                >
                  <img
                    src={`/images/products/${product.slug}/${img}`}
                    alt={img.replace(/[-_]/g, " ").replace(/\.\w+$/, "")}
                    class="w-full h-full object-cover"
                    loading="lazy"
                  />
                </button>
              ))}
            </div>
          )}
        </div>

        <!-- RIGHT: Info column -->
        <div class="lg:sticky lg:top-28 fade-up fade-up-delay-2">
          <span class="section-label">{product.category}</span>
          <h1 class="font-display text-4xl md:text-5xl text-ink-100 mt-3 mb-2">
            {product.name}
          </h1>
          <p class="text-gold-gradient font-display text-xl italic mb-6">{product.tagline}</p>

          <p class="text-ink-300 leading-relaxed mb-8">
            {product.description}
          </p>

          <!-- Price -->
          <div class="border-t border-b border-[#2a2520] py-6 mb-8">
            <p class="text-[0.65rem] font-label font-medium tracking-[0.2em] uppercase text-ink-400 mb-1">
              MSRP Range
            </p>
            <p class="font-display text-3xl text-gold-400">
              {formatPrice(product.priceFrom)} <span class="text-ink-400 text-lg">–</span> {formatPrice(product.priceTo)}
              <span class="text-ink-400 text-base font-body font-light"> / pair</span>
            </p>
            <p class="text-ink-400 text-xs font-label tracking-wider mt-2 uppercase">
              {SHIPPING_NOTE}
            </p>
          </div>

          <!-- Finish swatches -->
          <div class="mb-8" id="finish-selector" data-speaker={product.slug}>
            <p class="text-[0.65rem] font-label font-semibold tracking-[0.2em] uppercase text-ink-300 mb-1">
              Available Finishes
            </p>
            <p id="active-finish-name" class="text-ink-200 text-sm mb-4 h-5">&nbsp;</p>

            {(["standard", "premium", "exotic"] as const).map((tier) => (
              finishesByTier(tier).length > 0 && (
                <div class="mb-3">
                  <span class={`text-[0.55rem] font-label tracking-[0.25em] uppercase block mb-2 ${
                    tier === "standard" ? "text-ink-500" :
                    tier === "premium" ? "text-gold-400/60" :
                    "text-gold-300/60"
                  }`}>{tier}</span>
                  <div class="flex flex-wrap gap-2">
                    {finishesByTier(tier).map((f) => {
                      const slug = finishSlug(f.name);
                      const hasPhoto = slug in speakerFinishMap;
                      const photoFile = hasPhoto ? speakerFinishMap[slug] : "";
                      return (
                        <button
                          class={`finish-swatch group/swatch relative overflow-hidden rounded-sm transition-all duration-300 ${
                            tier === "exotic" ? "ring-1 ring-gold-500/20" :
                            tier === "premium" ? "ring-1 ring-gold-500/10" :
                            "ring-1 ring-[#2a2520]"
                          }`}
                          data-finish={slug}
                          data-name={f.name}
                          data-tier={tier}
                          data-photo={hasPhoto ? `/images/products/${product.slug}/${photoFile}` : ""}
                          title={`${f.name}${hasPhoto ? "" : " (swatch only)"}`}
                          aria-label={`Select ${f.name} finish`}
                        >
                          <img
                            src={swatchPath(f.name)}
                            alt={f.name}
                            class="w-11 h-11 object-cover block transition-transform duration-300 group-hover/swatch:scale-110"
                            loading="lazy"
                          />
                          {/* Subtle overlay for non-available-photo finishes */}
                          {!hasPhoto && (
                            <div class="absolute inset-0 bg-[rgba(8,8,8,0.25)] pointer-events-none"></div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                </div>
              )
            ))}
          </div>

          <!-- CTA Buttons -->
          <div class="space-y-3">
            <!-- Primary: Call to Order -->
            <a href={PHONE_HREF} class="btn-gold w-full text-center block">
              <span class="flex items-center justify-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                Call to Order — {PHONE_NUMBER}
              </span>
            </a>

            <!-- Secondary: Request a Quote / Consultation -->
            <a href="/#contact" class="btn-outline w-full text-center block">
              Request a Personalized Quote
            </a>
          </div>

          <!-- Custom order note -->
          <div class="mt-6 p-4 bg-[#0c0c0c] border border-[#2a2520]">
            <p class="text-ink-400 text-xs leading-relaxed">
              <span class="text-gold-400 font-label font-semibold tracking-wider text-[0.6rem] uppercase">Custom Orders:</span><br/>
              Not seeing your preferred finish in stock? We can order any Legacy Audio speaker in your choice of finish. {CUSTOM_ORDER_LEAD}. Call Dave to discuss options and place your order.
            </p>
          </div>

          {product.discontinued && (
            <div class="mt-4 p-4 bg-[rgba(220,38,38,0.05)] border border-red-500/15">
              <p class="text-red-400/80 text-xs leading-relaxed">
                <span class="font-label font-semibold tracking-wider text-[0.6rem] uppercase">Discontinued Model:</span><br/>
                The {product.name} has been discontinued by Legacy Audio. This is the last pair available anywhere. Once they're gone, they're gone. Call today to secure yours.
              </p>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- ─── SPECIFICATIONS ────────────────────────────────────────── -->
  <section class="py-16 lg:py-24 border-t border-[#2a2520]">
    <div class="max-w-7xl mx-auto px-6 lg:px-12">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">

        <!-- Specs table -->
        <div class="fade-up">
          <span class="section-label">Specifications</span>
          <div class="gold-rule mt-4 mb-8"></div>

          <div class="space-y-0">
            {product.specs.map((spec, i) => (
              <div class={`flex justify-between items-baseline py-3 ${i < product.specs.length - 1 ? "border-b border-[#1c1814]" : ""}`}>
                <span class="text-ink-400 text-sm font-label tracking-wider uppercase text-[0.65rem]">
                  {spec.label}
                </span>
                <span class="text-ink-200 text-sm text-right max-w-[55%]">
                  {spec.value}
                </span>
              </div>
            ))}
          </div>
        </div>

        <!-- Highlights -->
        <div class="fade-up fade-up-delay-2">
          <span class="section-label">Why This Speaker</span>
          <div class="gold-rule mt-4 mb-8"></div>

          <div class="space-y-5">
            {product.highlights.map((h) => (
              <div class="flex gap-4">
                <div class="flex-shrink-0 w-1 bg-gradient-to-b from-gold-500 to-gold-700 mt-1.5 rounded-full" style="height: 14px;"></div>
                <p class="text-ink-300 text-sm leading-relaxed">{h}</p>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ─── RELATED SPEAKERS ──────────────────────────────────────── -->
  {related.length > 0 && (
    <section class="py-16 lg:py-24 border-t border-[#2a2520]">
      <div class="max-w-7xl mx-auto px-6 lg:px-12">
        <span class="section-label fade-up">Also Available</span>
        <div class="gold-rule mt-4 mb-10 fade-up fade-up-delay-1"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          {related.map((r, i) => (
            <a
              href={`/products/${r.slug}`}
              class={`group block fade-up fade-up-delay-${Math.min(i + 1, 4)}`}
            >
              <div class="relative overflow-hidden">
                <img
                  src={`/images/products/${r.slug}/${r.heroImage}`}
                  alt={r.name}
                  class="w-full aspect-[4/3] object-cover brightness-[0.8] group-hover:brightness-[0.95] transition-all duration-500 group-hover:scale-[1.03]"
                  loading="lazy"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-[rgba(8,8,8,0.85)] via-transparent to-transparent"></div>
                <div class="absolute bottom-4 left-4 right-4">
                  <span class="text-[0.55rem] font-label tracking-[0.25em] uppercase text-gold-400">{r.category}</span>
                  <h3 class="font-display text-xl text-ink-100 mt-1 group-hover:text-gold-400 transition-colors">{r.name}</h3>
                  <p class="text-ink-400 text-sm mt-1">From {formatPrice(r.priceFrom)} / pair</p>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- ─── FOOTER ────────────────────────────────────────────────── -->
  <footer class="border-t border-[#2a2520] py-12">
    <div class="max-w-7xl mx-auto px-6 lg:px-12 flex flex-col md:flex-row items-center justify-between gap-6">
      <div class="flex items-center gap-3">
        <span class="font-display text-lg text-ink-100">In Depth Audio</span>
        <span class="text-ink-500 text-sm">·</span>
        <span class="text-ink-400 text-xs font-label tracking-wider uppercase">Scottsdale, AZ</span>
      </div>
      <div class="flex items-center gap-8">
        <a href="/" class="nav-link text-[0.6rem]">Home</a>
        <a href="/products" class="nav-link text-[0.6rem]">Speakers</a>
        <a href="/#contact" class="nav-link text-[0.6rem]">Contact</a>
      </div>
      <p class="text-ink-500 text-xs">&copy; {new Date().getFullYear()} In Depth Audio. All rights reserved.</p>
    </div>
  </footer>

</Layout>

<style>
  .gallery-thumb {
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.3s ease, border-color 0.3s ease;
  }

  .gallery-thumb:hover,
  .gallery-thumb.active-thumb {
    opacity: 1;
  }

  .active-thumb {
    border-color: rgba(201, 166, 74, 0.5) !important;
  }

  /* ── Finish swatches ─────────────────────────────────────────── */
  .finish-swatch {
    cursor: pointer;
    opacity: 0.75;
    transition: opacity 0.3s ease, ring-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
  }

  .finish-swatch:hover {
    opacity: 1;
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  }

  .finish-swatch.swatch-active {
    opacity: 1;
    ring-color: rgba(201, 166, 74, 0.7);
    box-shadow: 0 0 0 2px rgba(201, 166, 74, 0.6), 0 4px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.05);
  }
</style>

<script>
  // ─── Nav scroll ──────────────────────────────────────────────────
  const nav = document.getElementById("nav");
  window.addEventListener("scroll", () => {
    if (window.scrollY > 40) nav?.classList.add("nav-scrolled");
    else nav?.classList.remove("nav-scrolled");
  });
  if (window.scrollY > 40) nav?.classList.add("nav-scrolled");

  // ─── Mobile menu ─────────────────────────────────────────────────
  const menuBtn = document.getElementById("mobile-menu-btn");
  const drawer = document.getElementById("mobile-drawer");
  menuBtn?.addEventListener("click", () => drawer?.classList.toggle("hidden"));

  // ─── Gallery thumbnail switching ─────────────────────────────────
  const mainImage = document.getElementById("main-image") as HTMLImageElement | null;
  const thumbs = document.querySelectorAll(".gallery-thumb");

  function setMainImage(src: string) {
    if (mainImage && src) {
      // Smooth crossfade
      mainImage.style.opacity = "0";
      setTimeout(() => {
        mainImage.src = src;
        mainImage.onload = () => {
          mainImage.style.opacity = "1";
        };
      }, 150);
    }
  }

  function clearActiveThumb() {
    thumbs.forEach((t) => t.classList.remove("active-thumb"));
  }

  thumbs.forEach((thumb) => {
    thumb.addEventListener("click", () => {
      const src = (thumb as HTMLElement).dataset.src;
      if (src) {
        setMainImage(src);
        clearActiveThumb();
        thumb.classList.add("active-thumb");
        // Also clear active swatch since user picked a gallery image
        document.querySelectorAll(".finish-swatch").forEach((s) => s.classList.remove("swatch-active"));
        const nameEl = document.getElementById("active-finish-name");
        if (nameEl) nameEl.innerHTML = "&nbsp;";
      }
    });
  });

  // ─── Finish swatch clicking ────────────────────────────────────
  const swatches = document.querySelectorAll(".finish-swatch");
  const finishNameDisplay = document.getElementById("active-finish-name");

  swatches.forEach((swatch) => {
    swatch.addEventListener("click", () => {
      const el = swatch as HTMLElement;
      const name = el.dataset.name || "";
      const photo = el.dataset.photo || "";
      const tier = el.dataset.tier || "";

      // Highlight active swatch
      swatches.forEach((s) => s.classList.remove("swatch-active"));
      swatch.classList.add("swatch-active");

      // Show finish name with tier label
      if (finishNameDisplay) {
        const tierLabel = tier.charAt(0).toUpperCase() + tier.slice(1);
        if (photo) {
          finishNameDisplay.innerHTML = `<span class="text-ink-100">${name}</span> <span class="text-ink-500 text-xs">· ${tierLabel}</span>`;
        } else {
          finishNameDisplay.innerHTML = `<span class="text-ink-100">${name}</span> <span class="text-ink-500 text-xs">· ${tierLabel} · Photo not available</span>`;
        }
      }

      // Swap main image if this finish has a dedicated photo
      if (photo) {
        setMainImage(photo);
        // Also clear gallery thumb highlights
        clearActiveThumb();
      }
    });
  });

  // ─── Scroll animations ──────────────────────────────────────────
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((e) => {
        if (e.isIntersecting) {
          e.target.classList.add("visible");
          observer.unobserve(e.target);
        }
      });
    },
    { threshold: 0.1, rootMargin: "0px 0px -40px 0px" }
  );

  document.querySelectorAll(".fade-up, .fade-in").forEach((el) => observer.observe(el));
</script>
